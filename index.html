<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Archivio Contatti + Volantini + Mappa Copertura</title>

  <style>
    :root{
      --bg:#0a0a0a;
      --text:#f3f4f6;
      --muted:#a0adb8;
      --border:rgba(255,255,255,.12);
      --gold:#d8a23a;
      --gold2:#ffd166;
      --ok:#25d366;
      --bad:#ff4d4d;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --chip: rgba(0,0,0,.22);
      --chip2: rgba(255,255,255,.06);
    }

    *{ box-sizing:border-box; }

    body{
      margin: 24px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(216,162,58,.14), transparent 60%),
        radial-gradient(900px 600px at 85% 30%, rgba(123,79,189,.10), transparent 55%),
        var(--bg);
    }

    h1{ margin:0 0 10px; }
    h2{ margin:0 0 10px; }
    h3{ margin:12px 0 8px; color: rgba(243,244,246,.95); }

    .small{ font-size: 12px; color: var(--muted); }
    .mono{ font-family: var(--mono); }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    @media (max-width: 980px){ .grid{ grid-template-columns:1fr; } }

    .card{
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
    }

    .row{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap:10px;
      align-items:center;
      margin: 8px 0;
    }

    input, select, textarea, button{
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.28);
      color: var(--text);
      outline:none;
    }
    textarea{ resize: vertical; min-height: 70px; }

    input:focus, select:focus, textarea:focus{
      border-color: rgba(216,162,58,.55);
      box-shadow: 0 0 0 6px rgba(216,162,58,.12);
    }

    button{
      cursor:pointer;
      font-weight: 950;
      border-color: rgba(216,162,58,.65);
      background: linear-gradient(135deg, rgba(255,209,102,.98), rgba(216,162,58,.85));
      color:#121212;
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
      transition: transform .14s ease, filter .14s ease, box-shadow .14s ease;
    }
    button:hover{
      transform: translateY(-2px);
      filter: brightness(1.06);
      box-shadow: 0 14px 32px rgba(0,0,0,.45);
    }
    button:active{ transform: translateY(0); filter: brightness(.98); }

    .btns{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }

    .pill{
      display:inline-block;
      padding: 2px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      font-size:12px;
      color: rgba(243,244,246,.86);
      background: rgba(0,0,0,.22);
    }
    .ok{ color: var(--ok); font-weight: 900; }
    .bad{ color: var(--bad); font-weight: 1000; }

    table{ width:100%; border-collapse: collapse; margin-top:10px; }
    th, td{ border-bottom: 1px solid rgba(255,255,255,.10); padding: 8px; text-align:left; vertical-align: top; }
    th{ color: rgba(243,244,246,.85); font-size: 12px; }
    tr:hover{ background: rgba(255,255,255,.04); }

    a{ color: rgba(255,209,102,.95); text-decoration:none; font-weight: 950; }
    a:hover{ text-decoration: underline; }

    /* pulse add */
    #btn_add.pulse{ animation: pulseAdd 1.2s ease-in-out infinite; }
    @keyframes pulseAdd{
      0%{ box-shadow: 0 0 0 0 rgba(216,162,58,.28); }
      60%{ box-shadow: 0 0 0 14px rgba(216,162,58,0); transform: translateY(-2px); }
      100%{ box-shadow: 0 0 0 0 rgba(216,162,58,0); transform: translateY(0); }
    }

    /* modal */
    .modalBackdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.68);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 14px;
    }
    .modalBackdrop.show{ display:flex; }
    .modalCard{
      width: min(920px, 96vw);
      max-height: min(84vh, 820px);
      overflow: auto;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 18px;
      box-shadow: 0 18px 60px rgba(0,0,0,.65);
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 12px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      position: sticky;
      top: 0;
      background: rgba(0,0,0,.38);
      backdrop-filter: blur(8px);
      z-index: 2;
    }
    .modalHeader .title{
      font-weight: 1000;
      letter-spacing:.2px;
      font-size: 12px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .modalBody{
      padding: 12px;
      color: rgba(243,244,246,.95);
      font-size: 12px;
      line-height: 1.35;
    }
    .modalBody h3{
      margin: 12px 0 6px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing:.8px;
      color: var(--muted);
    }
    .modalActions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .modalBtn{
      width:auto;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(216,162,58,.65);
      background: linear-gradient(135deg, rgba(255,209,102,.98), rgba(216,162,58,.85));
      color:#121212;
      font-weight: 1000;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
    }

    .warning{
      border: 1px solid rgba(216,162,58,.35);
      background: rgba(216,162,58,.10);
      border-radius: 14px;
      padding: 10px 12px;
      margin-top: 10px;
    }

    /* ===== MAPPA ===== */
    .mapWrap{
      display:grid;
      grid-template-columns: 1fr 1.2fr;
      gap: 12px;
    }
    @media (max-width: 980px){ .mapWrap{ grid-template-columns:1fr; } }

    .streetList{
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      background: rgba(0,0,0,.18);
      overflow: hidden;
    }
    .streetItem{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      cursor:pointer;
    }
    .streetItem:last-child{ border-bottom:none; }
    .streetItem:hover{ background: rgba(255,255,255,.04); }
    .streetItem.active{
      background: rgba(216,162,58,.12);
      outline: 1px solid rgba(216,162,58,.25);
    }
    .streetName{
      font-weight: 1000;
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .streetMeta{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .bar{
      width: 120px;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .bar > div{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(255,209,102,.95), rgba(216,162,58,.85));
    }

    .civicsBox{
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      background: rgba(0,0,0,.18);
      padding: 12px;
    }
    .civicsGrid{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }
    .civicChip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: var(--chip);
      font-weight: 950;
      font-size: 12px;
    }
    .civicChip .dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.20);
      border: 1px solid rgba(255,255,255,.18);
    }
    .civicChip.touched{
      border-color: rgba(216,162,58,.35);
      background: rgba(216,162,58,.12);
    }
    .civicChip.touched .dot{
      background: rgba(255,209,102,.95);
      border-color: rgba(216,162,58,.55);
    }
    .civicChip .mini{
      font-size: 11px;
      color: var(--muted);
      font-weight: 800;
    }
  </style>
</head>

<body>
  <h1>üìá Archivio Contatti + üì© Volantini + üó∫Ô∏è Mappa</h1>
  <div class="small">Dati salvati localmente nel browser. La ‚Äúmappa‚Äù cresce man mano che tocchi vie e civici (senza KPI giudicanti).</div>

  <div class="grid" style="margin-top:16px;">
    <div class="card">
      <h2>Contatti</h2>

      <div class="row">
        <div>ID contatto</div>
        <input id="c_id" placeholder="(automatico: C001, C002‚Ä¶)" />
      </div>
      <div class="row">
        <div>Nome</div>
        <input id="c_nome" placeholder="es. Mario Rossi" />
      </div>
      <div class="row">
        <div>Telefono</div>
        <input id="c_tel" placeholder="es. 3331234567" />
      </div>
      <div class="row">
        <div>Indirizzo</div>
        <input id="c_addr" placeholder="es. Via Roma 10" />
      </div>

      <div class="btns" style="margin-top:10px;">
        <button id="btn_add">Aggiungi contatto</button>
        <button id="btn_select">Seleziona contatto</button>
      </div>

      <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
        <span class="pill">Selezionato: <span id="selected_id" class="mono">‚Äî</span></span>
      </div>

      <div id="msg" style="margin-top:10px;"></div>

      <h3>Lista contatti</h3>
      <div id="contacts_table"></div>
    </div>

    <div class="card">
      <h2>Volantino del mese</h2>

      <div class="row">
        <div>Titolo</div>
        <input id="fly_title" placeholder="es. Promo Febbraio 2026" />
      </div>
      <div class="row">
        <div>Mese invio</div>
        <input id="fly_month" type="month" />
      </div>

      <div style="margin-top:10px;">
        <div class="small">Carica volantino (PDF/immagine)</div>
        <input id="fly_file" type="file" accept="application/pdf,image/*" />
      </div>

      <div style="margin-top:10px;">
        <div class="small">Note (opzionale)</div>
        <textarea id="fly_note" placeholder="es. Valido fino al 28/02, sconti su..."></textarea>
      </div>

      <div class="btns" style="margin-top:10px;">
        <button id="btn_fly_save">Salva in archivio</button>
        <button id="btn_fly_preview">Apri/Preview</button>
      </div>

      <div class="btns" style="margin-top:10px;">
        <button id="btn_fly_whatsapp">Invia tramite WhatsApp</button>
        <button id="btn_fly_copy">Copia testo WhatsApp</button>
      </div>

      <div class="warning small">
        WhatsApp non permette di allegare automaticamente file via link: il bottone apre la chat con testo pronto, poi alleghi il volantino manualmente.
      </div>

      <h3>Archivio volantini</h3>
      <div id="fly_list" class="small">‚Äî</div>
    </div>
  </div>

  <div class="card" style="margin-top:16px;">
    <h2>üó∫Ô∏è Mappa copertura (vie + civici)</h2>
    <div class="small">Qui non ‚Äúvaluti‚Äù nessuno: vedi solo il territorio che si riempie col lavoro. Ogni selezione/WhatsApp segna un civico.</div>

    <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
      <span class="pill">Vie in archivio: <span id="map_streets" class="mono">0</span></span>
      <span class="pill">Civici in archivio: <span id="map_civics_total" class="mono">0</span></span>
      <span class="pill">Civici toccati: <span id="map_civics_touched" class="mono">0</span></span>
      <span class="pill">Ultimo ‚Äútoccat–æ‚Äù: <span id="map_last_touch" class="mono">‚Äî</span></span>

      <div style="margin-left:auto; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <span class="small">Filtro mese</span>
        <input id="map_month" type="month" style="width:auto; min-width:160px;" />
        <button id="btn_map_clear_filter" type="button" style="width:auto;">Tutti</button>
      </div>
    </div>

    <div class="mapWrap" style="margin-top:12px;">
      <div class="streetList" id="street_list"></div>

      <div class="civicsBox">
        <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center;">
          <div>
            <div class="pill">Via: <span id="map_current_street" class="mono">‚Äî</span></div>
          </div>
          <div class="pill">Copertura via: <span id="map_street_cov" class="mono">‚Äî</span></div>
        </div>

        <div class="small" style="margin-top:10px;">
          ‚úÖ = civico ‚Äútoccato‚Äù (selezione contatto o invio WhatsApp). ‚óªÔ∏è = ancora da toccare.
        </div>

        <div class="civicsGrid" id="civics_grid"></div>
      </div>
    </div>
  </div>

  <!-- MODAL contatto -->
  <div class="modalBackdrop" id="contactModal" aria-hidden="true">
    <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="contactTitle">
      <div class="modalHeader">
        <div class="title" id="contactTitle">üìá Contatto selezionato</div>
        <button class="modalBtn" id="btnCloseContactModal" type="button">‚úï Chiudi</button>
      </div>
      <div class="modalBody" id="contactModalBody"></div>
    </div>
  </div>

<script>
/* ========= PERSISTENZA ========= */
const LS_KEY = "app_contacts_with_map_v1";
const LS_FLY_META = "flyers_meta_v1";
const DB_NAME = "flyers_db_v1";
const STORE = "flyers";

/* ========= STATE ========= */
const state = loadState() || { contacts: {}, selectedId: null, lastTouchISO: null, mapSelectedStreet: null };
let selectedId = state.selectedId || null;

/* ========= helpers ========= */
const $ = (sel) => document.querySelector(sel);
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
function escapeAttr(s){ return escapeHtml(s).replace(/"/g, '&quot;'); }
function setMsg(text, ok=true){
  $("#msg").innerHTML = ok ? `<div class="ok">‚úÖ ${escapeHtml(text)}</div>` : `<div class="bad">‚õî ${escapeHtml(text)}</div>`;
}
function saveState(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}
function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    return raw ? JSON.parse(raw) : null;
  }catch{ return null; }
}

/* ========= CONTATTI ========= */
function nextContactId(){
  const ids = Object.keys(state.contacts || {});
  let max = 0;
  ids.forEach(id=>{
    const m = String(id).match(/^C(\d+)$/i);
    if(m) max = Math.max(max, parseInt(m[1],10));
  });
  return "C" + String(max + 1).padStart(3,"0");
}

/* Parsing indirizzo -> via + civico (best-effort, non rompe nulla) */
function parseAddress(raw){
  const s = String(raw || "").trim();
  if(!s) return { street: "", civic: "" };

  // prova a prendere ultimo numero come civico
  const m = s.match(/(.+?)\s+(\d+[A-Za-z]?)\s*$/);
  if(m){
    const street = normalizeStreet(m[1]);
    const civic = String(m[2]).toUpperCase();
    return { street, civic };
  }
  // fallback: tutta stringa come via, civico sconosciuto
  return { street: normalizeStreet(s), civic: "" };
}

function normalizeStreet(street){
  const x = String(street || "").trim()
    .replace(/\s+/g," ")
    .replace(/[.,;:]+$/,"");
  return x;
}

function makeContactFromInputs(){
  let id = $("#c_id").value.trim();
  if(!id){
    id = nextContactId();
    $("#c_id").value = id;
  }
  const nome = $("#c_nome").value.trim() || "‚Äî";
  const telefono = $("#c_tel").value.trim() || "";
  const indirizzo = $("#c_addr").value.trim() || "";

  const parsed = parseAddress(indirizzo);
  return {
    id, nome, telefono, indirizzo,
    street: parsed.street, civic: parsed.civic,
    touches: [] // [{whenISO, reason}] -> costruisce la mappa
  };
}

/* ========= pulse add ========= */
function updateAddPulse(){
  const nome = $("#c_nome").value.trim();
  const tel  = $("#c_tel").value.trim();
  const addr = $("#c_addr").value.trim();
  const shouldPulse = (nome || tel || addr) && !selectedId;
  $("#btn_add").classList.toggle("pulse", !!shouldPulse);
}
["#c_nome","#c_tel","#c_addr","#c_id"].forEach(sel=>{
  const el = $(sel);
  if(el) el.addEventListener("input", updateAddPulse);
});

/* ========= ‚Äútocca‚Äù civico per la mappa ========= */
function touchContact(id, reason){
  const c = state.contacts[id];
  if(!c) return;

  const whenISO = new Date().toISOString();
  c.touches = Array.isArray(c.touches) ? c.touches : [];
  c.touches.push({ whenISO, reason: reason || "touch" });

  state.lastTouchISO = whenISO;
  saveState();
}

/* ========= render contatti ========= */
function renderContacts(){
  const rows = Object.values(state.contacts)
    .sort((a,b)=>a.id.localeCompare(b.id))
    .map(c => {
      const mark = (c.touches && c.touches.length) ? "‚úÖ" : "‚óªÔ∏è";
      const addrMini = c.street ? `${c.street}${c.civic ? " " + c.civic : ""}` : (c.indirizzo || "‚Äî");
      return `
        <tr>
          <td><a href="#" data-id="${escapeAttr(c.id)}">${escapeHtml(c.id)}</a></td>
          <td>${escapeHtml(c.nome || "‚Äî")}</td>
          <td class="mono">${escapeHtml(c.telefono || "‚Äî")}</td>
          <td>${escapeHtml(addrMini)}</td>
          <td class="mono">${mark}</td>
        </tr>
      `;
    }).join("");

  $("#contacts_table").innerHTML = `
    <table>
      <thead><tr><th>ID</th><th>Nome</th><th>Telefono</th><th>Via/Civico</th><th>Touch</th></tr></thead>
      <tbody>${rows || `<tr><td colspan="5" class="small">Nessun contatto ancora.</td></tr>`}</tbody>
    </table>
  `;

  document.querySelectorAll('a[data-id]').forEach(a=>{
    a.onclick = (ev)=>{ ev.preventDefault(); selectContact(a.dataset.id, "select_table"); };
  });
}

/* ========= select + modal ========= */
function selectContact(id, reason){
  if(!state.contacts[id]) throw new Error("Contatto non trovato: " + id);
  selectedId = id;
  state.selectedId = id;

  $("#selected_id").textContent = id;

  // segnalo ‚Äútouch‚Äù (costruzione mappa) anche solo selezionando
  touchContact(id, reason || "select");

  saveState();
  updateAddPulse();
  openContactModal(state.contacts[id]);

  // aggiorna mappa live
  renderMap();
}

function openContactModal(c){
  const telRaw = String(c.telefono || "").trim();
  const telDigits = telRaw.replace(/\D/g,"");
  const telLink = telDigits ? `tel:${telDigits}` : "";
  const waLink  = telDigits ? `https://wa.me/${telDigits}` : "";

  const addrNice = c.street ? `${c.street}${c.civic ? " " + c.civic : ""}` : (c.indirizzo || "‚Äî");
  const touches = (c.touches || []).slice().reverse().slice(0,5);

  $("#contactModalBody").innerHTML = `
    <h3>Come contattarlo</h3>
    <div class="pill">Telefono: <span class="mono">${escapeHtml(telRaw || "‚Äî")}</span></div>

    <div class="modalActions">
      <a class="modalBtn" href="${escapeAttr(telLink)}" ${telDigits ? "" : "onclick='return false'"}>üìû Chiama</a>
      <a class="modalBtn" href="${escapeAttr(waLink)}" target="_blank" rel="noopener" ${telDigits ? "" : "onclick='return false'"}>üü¢ WhatsApp</a>
      <button class="modalBtn" type="button" id="btn_touch_now">‚úÖ Segna ‚Äútoccato‚Äù ora</button>
    </div>

    <h3>Dettagli</h3>
    <div class="pill">ID: <span class="mono">${escapeHtml(c.id)}</span></div>
    <div style="margin-top:8px;"><b>Nome:</b> ${escapeHtml(c.nome || "‚Äî")}</div>
    <div style="margin-top:6px;"><b>Via/Civico:</b> ${escapeHtml(addrNice)}</div>

    <h3>Ultimi tocchi (mappa)</h3>
    ${
      touches.length ? `
        <table>
          <thead><tr><th>Quando</th><th>Motivo</th></tr></thead>
          <tbody>
            ${touches.map(t => `
              <tr>
                <td class="mono">${escapeHtml(new Date(t.whenISO).toLocaleString())}</td>
                <td>${escapeHtml(t.reason || "touch")}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      ` : `<div class="small">Nessun tocco registrato.</div>`
    }
  `;

  // bind segna touch
  const btn = document.getElementById("btn_touch_now");
  if(btn){
    btn.onclick = ()=>{
      touchContact(c.id, "manual_touch");
      setMsg("Segnato come toccato ‚úÖ", true);
      renderMap();
      // aggiorna modal (per vedere tocchi)
      openContactModal(state.contacts[c.id]);
    };
  }

  $("#contactModal").classList.add("show");
  $("#contactModal").setAttribute("aria-hidden","false");
}

function closeContactModal(){
  $("#contactModal").classList.remove("show");
  $("#contactModal").setAttribute("aria-hidden","true");
}
$("#btnCloseContactModal").onclick = closeContactModal;
$("#contactModal").addEventListener("click", (e)=>{
  if(e.target && e.target.id === "contactModal") closeContactModal();
});
document.addEventListener("keydown", (e)=>{
  if(e.key === "Escape") closeContactModal();
});

/* ========= CONTATTI buttons ========= */
$("#btn_add").onclick = ()=>{
  try{
    const c = makeContactFromInputs();
    state.contacts[c.id] = c;
    saveState();
    renderContacts();
    renderMap();
    setMsg("Contatto aggiunto: " + c.id, true);

    $("#c_id").value = "";
    $("#c_nome").value = "";
    $("#c_tel").value = "";
    $("#c_addr").value = "";
    updateAddPulse();
  }catch(e){ setMsg(e.message || String(e), false); }
};

$("#btn_select").onclick = ()=>{
  try{
    const id = $("#c_id").value.trim();
    if(!id) throw new Error("Inserisci un ID (es. C001) oppure clicca un contatto in tabella.");
    selectContact(id, "select_button");
    setMsg("Contatto selezionato: " + id, true);
  }catch(e){ setMsg(e.message || String(e), false); }
};

/* ========= VOLANTINI (IndexedDB per salvare file) ========= */
function openDB(){
  return new Promise((resolve, reject)=>{
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = (e)=>{
      const db = e.target.result;
      if(!db.objectStoreNames.contains(STORE)){
        db.createObjectStore(STORE, { keyPath: "id" });
      }
    };
    req.onsuccess = ()=> resolve(req.result);
    req.onerror = ()=> reject(req.error);
  });
}

async function dbPutFlyer(item){
  const db = await openDB();
  return new Promise((resolve, reject)=>{
    const tx = db.transaction(STORE, "readwrite");
    tx.objectStore(STORE).put(item);
    tx.oncomplete = ()=> resolve(true);
    tx.onerror = ()=> reject(tx.error);
  });
}

async function dbGetFlyer(id){
  const db = await openDB();
  return new Promise((resolve, reject)=>{
    const tx = db.transaction(STORE, "readonly");
    const req = tx.objectStore(STORE).get(id);
    req.onsuccess = ()=> resolve(req.result || null);
    req.onerror = ()=> reject(req.error);
  });
}

function flyerId(){
  return "F" + Date.now().toString(36) + Math.random().toString(36).slice(2,6);
}
function fmtMonth(ym){
  if(!ym) return "‚Äî";
  const [y,m] = ym.split("-");
  return `${m}/${y}`;
}

function saveFlyerMetaList(list){
  localStorage.setItem(LS_FLY_META, JSON.stringify(list));
}
function loadFlyerMetaList(){
  try{
    const raw = localStorage.getItem(LS_FLY_META);
    return raw ? JSON.parse(raw) : [];
  }catch{ return []; }
}

let flyersMeta = loadFlyerMetaList();
let selectedFlyerId = flyersMeta[0]?.id || null;

function getSelectedFlyerMeta(){
  if(!selectedFlyerId) return null;
  return flyersMeta.find(x=>x.id === selectedFlyerId) || null;
}

function currentFlyerMessage(contact){
  const c = contact || (selectedId ? state.contacts[selectedId] : null);
  const name = c?.nome && c.nome !== "‚Äî" ? c.nome : "ciao";
  const meta = getSelectedFlyerMeta();
  const title = meta?.title || "Volantino";
  const month = meta?.month ? fmtMonth(meta.month) : "";
  const note = meta?.note ? `\n\nNote: ${meta.note}` : "";
  return `Ciao ${name}! üëã\nTi mando il ${title}${month ? " ("+month+")" : ""}.${note}\n\n(Allego il volantino qui in chat)`;
}

function renderFlyers(){
  if(!flyersMeta.length){
    $("#fly_list").innerHTML = "‚Äî";
    return;
  }
  const rows = flyersMeta
    .slice()
    .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0))
    .map(f=>{
      const isSel = f.id === selectedFlyerId;
      return `
        <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,.08);">
          <div style="min-width:0;">
            <div style="font-weight:950; ${isSel ? "color: var(--gold2);" : ""}">${escapeHtml(f.title || "Volantino")}</div>
            <div class="small">Mese: <span class="mono">${escapeHtml(fmtMonth(f.month))}</span> ‚Ä¢ File: <span class="mono">${escapeHtml(f.filename || "‚Äî")}</span></div>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="modalBtn" data-sel="${escapeAttr(f.id)}" type="button">Seleziona</button>
          </div>
        </div>
      `;
    }).join("");

  $("#fly_list").innerHTML = rows;
  document.querySelectorAll("[data-sel]").forEach(btn=>{
    btn.onclick = ()=>{
      selectedFlyerId = btn.getAttribute("data-sel");
      renderFlyers();
    };
  });
}

$("#btn_fly_save").onclick = async ()=>{
  try{
    const title = $("#fly_title").value.trim() || "Volantino";
    const month = $("#fly_month").value || "";
    const note = $("#fly_note").value.trim() || "";
    const file = $("#fly_file").files?.[0];
    if(!file) throw new Error("Carica un file volantino (PDF o immagine).");

    const id = flyerId();
    const blob = file;
    const mime = file.type || "application/octet-stream";
    const filename = file.name || "volantino";

    await dbPutFlyer({ id, blob, mime, filename, createdAt: Date.now() });

    const meta = { id, title, month, note, mime, filename, createdAt: Date.now() };
    flyersMeta.push(meta);
    saveFlyerMetaList(flyersMeta);
    selectedFlyerId = id;

    $("#fly_file").value = "";
    setMsg("Volantino salvato in archivio ‚úÖ", true);
    renderFlyers();
  }catch(e){
    setMsg(e.message || String(e), false);
  }
};

$("#btn_fly_preview").onclick = async ()=>{
  try{
    const meta = getSelectedFlyerMeta();
    if(!meta) throw new Error("Nessun volantino selezionato.");
    const rec = await dbGetFlyer(meta.id);
    if(!rec?.blob) throw new Error("File non trovato in archivio (IndexedDB).");

    const url = URL.createObjectURL(rec.blob);
    window.open(url, "_blank", "noopener");
    setTimeout(()=> URL.revokeObjectURL(url), 60_000);
  }catch(e){
    setMsg(e.message || String(e), false);
  }
};

$("#btn_fly_copy").onclick = async ()=>{
  try{
    const text = currentFlyerMessage(selectedId ? state.contacts[selectedId] : null);
    await navigator.clipboard.writeText(text);
    setMsg("Testo WhatsApp copiato ‚úÖ", true);
  }catch{
    const ta = document.createElement("textarea");
    ta.value = currentFlyerMessage(selectedId ? state.contacts[selectedId] : null);
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    ta.remove();
    setMsg("Testo WhatsApp copiato ‚úÖ", true);
  }
};

$("#btn_fly_whatsapp").onclick = ()=>{
  try{
    if(!selectedId) throw new Error("Seleziona prima un contatto.");
    const c = state.contacts[selectedId];
    const telDigits = String(c.telefono || "").replace(/\D/g,"");
    if(!telDigits) throw new Error("Il contatto non ha un numero valido.");

    // touch mappa (azione reale)
    touchContact(selectedId, "whatsapp_flyer");

    const msg = currentFlyerMessage(c);
    const url = `https://wa.me/${telDigits}?text=${encodeURIComponent(msg)}`;
    window.open(url, "_blank", "noopener");

    setMsg("WhatsApp aperto ‚úÖ (allega il volantino in chat). Mappa aggiornata.", true);
    renderMap();
  }catch(e){
    setMsg(e.message || String(e), false);
  }
};

/* ========= MAPPA ========= */

/* costruiamo: street -> { civics: Map(civic -> {touchedCount, lastTouchedISO}) } */
function buildMapData(monthFilter){
  const byStreet = new Map();

  const monthPrefix = monthFilter ? (monthFilter + "-") : null; // YYYY-MM-

  for(const c of Object.values(state.contacts)){
    const street = (c.street || "").trim();
    const civic = (c.civic || "").trim();

    if(!street) continue; // senza via non mappo

    if(!byStreet.has(street)) byStreet.set(street, new Map());
    const civicsMap = byStreet.get(street);

    const civicKey = civic || "‚Äî"; // civico sconosciuto
    if(!civicsMap.has(civicKey)){
      civicsMap.set(civicKey, { total: 0, touched: 0, lastTouchedISO: null });
    }
    const node = civicsMap.get(civicKey);
    node.total += 1; // quanti contatti hai su quel civico (utile)

    // touched?
    const touches = Array.isArray(c.touches) ? c.touches : [];
    const touchesFiltered = monthPrefix
      ? touches.filter(t => String(t.whenISO || "").startsWith(monthPrefix))
      : touches;

    if(touchesFiltered.length){
      node.touched = 1; // civico ‚Äútoccato‚Äù (non conta quante volte: basta 1 per mappa)
      const last = touchesFiltered.reduce((acc, t)=> (acc && acc > t.whenISO) ? acc : t.whenISO, null);
      node.lastTouchedISO = last;
    }
  }

  return byStreet;
}

function getMapMonthFilter(){
  const v = $("#map_month").value;
  return v ? v : "";
}

function renderMap(){
  const monthFilter = getMapMonthFilter();
  const byStreet = buildMapData(monthFilter);

  const streets = Array.from(byStreet.keys()).sort((a,b)=>a.localeCompare(b, "it"));
  $("#map_streets").textContent = String(streets.length);

  let totalCivics = 0;
  let touchedCivics = 0;
  let lastTouch = null;

  // compute stats
  for(const st of streets){
    const civicsMap = byStreet.get(st);
    for(const [civ, node] of civicsMap.entries()){
      totalCivics += 1;
      if(node.touched){
        touchedCivics += 1;
        if(node.lastTouchedISO && (!lastTouch || node.lastTouchedISO > lastTouch)) lastTouch = node.lastTouchedISO;
      }
    }
  }

  $("#map_civics_total").textContent = String(totalCivics);
  $("#map_civics_touched").textContent = String(touchedCivics);
  $("#map_last_touch").textContent = lastTouch ? new Date(lastTouch).toLocaleString() : "‚Äî";

  // selected street
  if(!state.mapSelectedStreet || !byStreet.has(state.mapSelectedStreet)){
    state.mapSelectedStreet = streets[0] || null;
  }

  // render street list
  const list = $("#street_list");
  if(!streets.length){
    list.innerHTML = `<div class="small" style="padding:12px;">Nessuna via mappabile: inserisci indirizzi tipo ‚ÄúVia Roma 10‚Äù.</div>`;
    $("#map_current_street").textContent = "‚Äî";
    $("#map_street_cov").textContent = "‚Äî";
    $("#civics_grid").innerHTML = "";
    saveState();
    return;
  }

  list.innerHTML = streets.map(st=>{
    const civicsMap = byStreet.get(st);
    const civicsArr = Array.from(civicsMap.entries());
    const tot = civicsArr.length;
    const touched = civicsArr.filter(([,n])=>n.touched).length;
    const pct = tot ? Math.round((touched / tot) * 100) : 0;

    const active = (st === state.mapSelectedStreet) ? "active" : "";
    return `
      <div class="streetItem ${active}" data-street="${escapeAttr(st)}">
        <div style="min-width:0;">
          <div class="streetName">${escapeHtml(st)}</div>
          <div class="small">Civici: <span class="mono">${touched}/${tot}</span></div>
        </div>
        <div class="streetMeta">
          <div class="bar" title="${pct}%"><div style="width:${pct}%;"></div></div>
          <span class="pill mono">${pct}%</span>
        </div>
      </div>
    `;
  }).join("");

  list.querySelectorAll("[data-street]").forEach(el=>{
    el.onclick = ()=>{
      state.mapSelectedStreet = el.getAttribute("data-street");
      saveState();
      renderMap();
    };
  });

  // render civics grid for selected street
  const cur = state.mapSelectedStreet;
  $("#map_current_street").textContent = cur || "‚Äî";

  const civicsMap = byStreet.get(cur);
  const civicsArr = Array.from(civicsMap.entries())
    .sort((a,b)=>{
      // sort numeric civics first
      const aa = a[0], bb = b[0];
      const na = parseInt(String(aa).match(/^\d+/)?.[0] || "999999", 10);
      const nb = parseInt(String(bb).match(/^\d+/)?.[0] || "999999", 10);
      if(na !== nb) return na - nb;
      return String(aa).localeCompare(String(bb), "it");
    });

  const tot = civicsArr.length;
  const touched = civicsArr.filter(([,n])=>n.touched).length;
  $("#map_street_cov").textContent = `${touched}/${tot}`;

  $("#civics_grid").innerHTML = civicsArr.map(([civ, node])=>{
    const cls = node.touched ? "civicChip touched" : "civicChip";
    const last = node.lastTouchedISO ? new Date(node.lastTouchedISO).toLocaleDateString() : "";
    return `
      <div class="${cls}" title="${node.touched ? "Toccato" : "Non toccato"}">
        <span class="dot"></span>
        <span class="mono">${escapeHtml(civ)}</span>
        ${node.touched && last ? `<span class="mini">‚Ä¢ ${escapeHtml(last)}</span>` : ``}
      </div>
    `;
  }).join("");

  saveState();
}

/* ========= MAPPA UI events ========= */
$("#btn_map_clear_filter").onclick = ()=>{
  $("#map_month").value = "";
  renderMap();
};
$("#map_month").addEventListener("change", renderMap);

/* ========= VOLANTINI meta list init ========= */
function renderFlyersInit(){
  renderFlyers();
}

/* ========= INIT ========= */
renderContacts();
renderFlyersInit();
updateAddPulse();
if(selectedId && state.contacts[selectedId]){
  $("#selected_id").textContent = selectedId;
}
renderMap();
</script>
</body>
</html>
